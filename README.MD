# 功能增強的多人線上聊天室專案
**含私訊與檔案傳輸功能**

## 📋 專案概述

這個專案是 Exp1 (P2P 聊天) 和 Exp3 (TCP Client-Server) 的結合並向上升級版本，實現了比單純 P2P 聊天更強大且穩健的通訊系統。使用者登入後進入公共聊天大廳，可以進行群聊、查看在線使用者列表、點擊列表中的使用者進行私訊，甚至可以互相傳送小型檔案。

## 🎯 項目需求

### 核心功能需求
1. **使用者認證系統**
   - 使用者登入/登出功能
   - 使用者名稱驗證與重複檢查
   - 線上使用者狀態管理

2. **多人群聊功能**
   - 公共聊天大廳
   - 即時訊息廣播
   - 聊天紀錄顯示

3. **私訊系統**
   - 點擊使用者列表進行私訊
   - 私訊視窗或標記機制
   - 訊息定向傳送

4. **在線使用者管理**
   - 即時更新在線使用者列表
   - 使用者狀態變更通知
   - 使用者介面互動


### 非功能性需求
- **效能**：支援多人同時線上聊天
- **穩定性**：網路連線異常處理
- **使用者體驗**：直觀的圖形化介面
- **安全性**：基本的使用者驗證

## 🛠 技術棧

### 主要技術
- **程式語言**：C# (.NET 8.0+)
- **GUI 框架**：Windows Forms
- **網路協定**：TCP Socket
- **架構模式**：Client-Server 架構

### 關鍵元件
- **伺服器端**：
  - TCP Listener 處理多客戶端連線
  - 訊息路由與廣播邏輯
  - 使用者會話管理
  - 檔案傳輸協調

- **客戶端**：
  - TCP Client 連線管理
  - 多執行緒 UI 更新
  - 本地訊息緩存
  - 檔案選擇與傳輸

### 資料儲存
- **即時資料**：記憶體內管理 (Dictionary, List)
- **設定檔**：本地 JSON 或 XML 設定檔
- **日誌**：Console.WriteLine 和簡單文件日誌

## 🗺 專案里程碑

### 里程碑 1：基礎架構建立 (第 1-2 週)
**目標**：建立 Client-Server 基礎通訊架構
- [ ] 建立 TCP Server 基礎類別
- [ ] 建立 TCP Client 基礎類別
- [ ] 實現基本連線建立與斷線處理
- [ ] 設計基本的訊息協定格式
- [ ] 實現多客戶端同時連線

**測試方式**：多個客戶端可同時連線到伺服器，連線狀態正常顯示

### 里程碑 2：使用者系統與群聊 (第 3-4 週) ✅ **已完成**
**目標**：實現使用者登入和群聊功能
- [x] 實現使用者登入/登出機制
- [x] 建立使用者會話管理
- [x] 實現群聊訊息廣播
- [x] 設計並實現聊天室 UI 介面
- [x] 實現在線使用者列表顯示

**已完成功能**：
- ✅ 圖形化 Windows Forms 聊天室介面
- ✅ 時間戳記顯示和訊息格式化
- ✅ 系統通知（使用者加入/離開）
- ✅ 即時使用者列表更新

**測試方式**：多個使用者可以登入並在群聊中互相看到訊息

### 里程碑 3：私訊系統 (第 5 週) ✅ **已完成並強化**
**目標**：實現點對點私訊功能，並進行功能強化與 UI 優化

**已完成功能**：
- [x] 設計私訊協定格式 (`PRIVATE:target_username:message`)
- [x] 實現伺服器端私訊路由邏輯
- [x] 透過在主輸入框使用 `@使用者` 格式，優化了發送體驗
- [x] 實現使用者列表雙擊以快速發起私訊
- [x] 加入未讀訊息標記 (`*`)
- [x] 當私訊目標離線時，向發送方顯示提示

**測試方式**：使用者可以透過 `@使用者` 格式進行私訊，訊息正確傳達，並能看到未讀標記。

### 里程碑 4：檔案傳輸 (第 6 週)
**目標**：實現客戶端之間的檔案傳輸功能
- [ ] 設計檔案傳輸協定 (請求/回應)
- [ ] 實現客戶端檔案選擇介面
- [ ] 實現伺服器中轉檔案邏輯
- [ ] 處理檔案分片與合併
- [ ] 加入傳輸進度指示

**測試方式**：使用者 A 可以成功將一個小型檔案傳送給使用者 B。

### 里程碑 5：系統完善與優化 (第 7 週)
**目標**：系統穩定性提升和功能完善
- [ ] 實現網路異常處理機制
- [ ] 加入系統日誌記錄
- [ ] 優化 UI 使用者體驗
- [ ] 實現 P2P 直連檔案傳輸 (進階選項)
- [ ] 系統測試與 Bug 修復

**測試方式**：系統在各種網路情況下穩定運行，所有功能正常

## 🏗 系統架構設計

### 核心概念架構
```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Client A      │────▶│     Server      │◀────│   Client B      │
│                 │     │                 │     │                 │
│ - GUI Interface │     │ - User Manager  │     │ - GUI Interface │
│ - TCP Client    │     │ - Message Router│     │ - TCP Client    │
│ - File Handler  │     │ - File Mediator │     │ - File Handler  │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 訊息協定設計
- **群聊廣播**：
  - 客戶端發送: `BROADCAST:message_content`
  - 伺服器廣播: `BROADCAST:timestamp:username:message_content`
- **私人訊息**：
  - 客戶端發送: `PRIVATE:target_username:message_content`
  - 伺服器轉發: `PRIVATE:timestamp:sender_username:target_username:message_content`
- **使用者登入**：`LOGIN:username`
- **使用者登出**：`LOGOUT:username`
- **檔案傳送 (尚未實現)**：
  - `FILE_REQUEST:target_username:filename:filesize`
  - `FILE_RESPONSE:sender_username:accept/reject`

### 系統流程

#### 1. 登入流程
1. 客戶端啟動，顯示登入對話框
2. 使用者輸入使用者名稱，點擊連線
3. 客戶端向伺服器發送 `LOGIN:username`
4. 伺服器驗證使用者名稱是否重複
5. 登入成功後進入聊天室主介面

#### 2. 群聊流程
1. 使用者在訊息輸入框輸入內容
2. 點擊發送按鈕
3. 客戶端發送 `BROADCAST:message_content`
4. 伺服器接收後廣播給所有在線客戶端
5. 所有客戶端更新聊天紀錄顯示

#### 3. 私訊流程
1. 使用者在主聊天視窗的輸入框中，輸入 `@目標使用者名稱` 後跟隨訊息內容。
2. (或) 使用者雙擊在線列表中的目標使用者，系統會自動在輸入框填上 `@目標使用者名稱`。
3. 客戶端發送 `PRIVATE:target_username:message_content`。
4. 伺服器解析目標使用者，若其在線，則轉發訊息。
5. 目標客戶端收到私訊，在聊天視窗顯示內容，並在使用者列表中標記未讀來源。
6. 若目標使用者離線，伺服器會回傳錯誤訊息給發送方。

#### 4. 檔案傳輸流程 (尚未實現)

**方案一：伺服器中轉 (優先實現)**
1. 使用者 A 選擇檔案並指定接收者 B
2. A 發送 `FILE_REQUEST:B:filename:filesize` 給伺服器
3. 伺服器轉發請求給 B
4. B 回應 `FILE_RESPONSE:A:accept`
5. A 將檔案分片上傳到伺服器
6. 伺服器將檔案分片轉發給 B
7. B 接收完成後組合檔案

**方案二：P2P 直連 (進階功能)**
1. 使用者 A 向伺服器請求與 B 建立直連
2. 伺服器協調並提供雙方 IP 資訊
3. A 和 B 建立臨時 TCP 直連
4. 直接進行檔案傳輸
5. 傳輸完成後關閉直連

## 🧪 測試策略

### 單元測試
- TCP 連線建立與斷線
- 訊息協定解析
- 使用者會話管理
- 檔案分片處理

### 整合測試
- 多客戶端同時連線
- 群聊訊息廣播正確性
- 私訊定向傳送正確性
- 檔案傳輸完整性

### 使用者測試
- UI 操作流暢性
- 網路異常恢復
- 大檔案傳輸穩定性

## 🚀 部署與運行

### 開發環境需求
- Visual Studio 2022 或 Cursor IDE
- .NET 8.0 或更高版本
- Windows 10/11 作業系統

### 運行步驟
1. 首先啟動伺服器程式
2. 配置伺服器監聽埠 (預設：8888)
3. 啟動多個客戶端程式進行測試
4. 在瀏覽器控制台查看詳細日誌

### 回退機制
- 使用 Git 版本控制追蹤變更
- 在 Cursor IDE 中使用「回退到檢查點」功能
- 保存重要里程碑的穩定版本

## 🔧 故障排除

### 常見問題
1. **連線失敗**：檢查伺服器是否啟動，防火牆設定
2. **訊息延遲**：檢查網路狀況，伺服器負載
3. **檔案傳輸中斷**：實現斷點續傳機制
4. **使用者重複登入**：加強使用者名稱驗證

### 日誌記錄
- 關鍵操作使用 `Console.WriteLine` 記錄
- 錯誤處理包含詳細錯誤訊息
- 網路事件記錄時間戳記

## 🎨 技術亮點

1. **架構優勢**：實現了比 P2P 更穩健、功能更豐富的通訊系統
2. **伺服器邏輯**：練習了複雜的資料轉發規則和使用者會話管理
3. **多執行緒處理**：客戶端 UI 不會因網路操作而凍結
4. **協定設計**：可擴展的訊息協定，易於新增功能
5. **混合架構**：結合 Client-Server 和 P2P 的優點

## 📚 相關資源

- [.NET Socket 程式設計文檔](https://docs.microsoft.com/dotnet/api/system.net.sockets.socket)
- [Windows Forms 開發指南](https://docs.microsoft.com/dotnet/desktop/winforms/)
- [TCP 協定詳解](https://tools.ietf.org/html/rfc793)

---

**專案狀態**：規劃階段  
**預計完成時間**：7 週  
**最後更新**：2024 年 12 月
