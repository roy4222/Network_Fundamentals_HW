# 功能增強的多人線上聊天室專案
**含私訊與檔案傳輸功能**

## 📋 專案概述

這個專案是 Exp1 (P2P 聊天) 和 Exp3 (TCP Client-Server) 的結合並向上升級版本，實現了比單純 P2P 聊天更強大且穩健的通訊系統。使用者登入後進入公共聊天大廳，可以進行群聊、查看在線使用者列表、點擊列表中的使用者進行私訊，甚至可以互相傳送小型檔案。

## 🎯 項目需求

### 核心功能需求
1. **使用者認證系統**
   - 使用者登入/登出功能
   - 使用者名稱驗證與重複檢查
   - 線上使用者狀態管理

2. **多人群聊功能**
   - 公共聊天大廳
   - 即時訊息廣播
   - 聊天紀錄顯示

3. **私訊系統**
   - 點擊使用者列表進行私訊
   - 私訊視窗或標記機制
   - 訊息定向傳送

4. **在線使用者管理**
   - 即時更新在線使用者列表
   - 使用者狀態變更通知
   - 使用者介面互動

5. **系統通知**
   - 使用者加入/離開通知
   - 系統狀態訊息
   - 錯誤處理與提示

## 🚀 啟動步驟

### 步驟 1：啟動伺服器
1. 打開終端機或命令提示字元
2. 切換到伺服器目錄：
   ```bash
   cd final/Server
   ```
3. 啟動伺服器：
   ```bash
   dotnet run
   ```
4. 看到 "伺服器已啟動..." 訊息表示成功

### 步驟 2：啟動客戶端
有兩種方式可以啟動客戶端：

#### 方式一：使用執行檔 (推薦)
1. 使用檔案總管導航到：
   ```
   final/Client/bin/Debug/net8.0-windows/
   ```
2. 找到 `Client.exe` 檔案
3. **想要幾個客戶端就點擊幾次** `Client.exe`
4. 每次點擊都會開啟一個新的聊天客戶端視窗

#### 方式二：使用命令列
1. 打開新的終端機視窗
2. 切換到客戶端目錄：
   ```bash
   cd final/Client
   ```
3. 啟動客戶端：
   ```bash
   dotnet run
   ```
4. 若要開啟多個客戶端，請重複開啟新終端機並執行相同指令

### 步驟 3：開始聊天
1. 在客戶端視窗中輸入使用者名稱
2. 點擊「連線」按鈕
3. 成功連線後即可開始群聊
4. 點擊右側使用者列表中的其他使用者進行私訊
5. 使用檔案傳輸功能分享檔案

### 注意事項
- 請確保伺服器先啟動，再啟動客戶端
- 預設連線位址為 `localhost:8888`
- 支援同時多人線上聊天
- 建議使用方式一啟動多個客戶端進行測試



### 非功能性需求
- **效能**：支援多人同時線上聊天
- **穩定性**：網路連線異常處理
- **使用者體驗**：直觀的圖形化介面
- **安全性**：基本的使用者驗證

## 🛠 技術棧

### 主要技術
- **程式語言**：C# (.NET 8.0+)
- **GUI 框架**：Windows Forms
- **網路協定**：TCP Socket
- **架構模式**：Client-Server 架構

### 關鍵元件
- **伺服器端**：
  - TCP Listener 處理多客戶端連線
  - 訊息路由與廣播邏輯
  - 使用者會話管理
  - 檔案傳輸協調

- **客戶端**：
  - TCP Client 連線管理
  - 多執行緒 UI 更新
  - 本地訊息緩存
  - 檔案選擇與傳輸

### 資料儲存
- **即時資料**：記憶體內管理 (Dictionary, List)
- **設定檔**：本地 JSON 或 XML 設定檔
- **日誌**：Console.WriteLine 和簡單文件日誌

## 🗺 專案里程碑

### 里程碑 1：基礎架構建立 (第 1-2 週)
**目標**：建立 Client-Server 基礎通訊架構
- [ ] 建立 TCP Server 基礎類別
- [ ] 建立 TCP Client 基礎類別
- [ ] 實現基本連線建立與斷線處理
- [ ] 設計基本的訊息協定格式
- [ ] 實現多客戶端同時連線

**測試方式**：多個客戶端可同時連線到伺服器，連線狀態正常顯示

### 里程碑 2：使用者系統與群聊 (第 3-4 週) ✅ **已完成**
**目標**：實現使用者登入和群聊功能
- [x] 實現使用者登入/登出機制
- [x] 建立使用者會話管理
- [x] 實現群聊訊息廣播
- [x] 設計並實現聊天室 UI 介面
- [x] 實現在線使用者列表顯示

**已完成功能**：
- ✅ 圖形化 Windows Forms 聊天室介面
- ✅ 時間戳記顯示和訊息格式化
- ✅ 系統通知（使用者加入/離開）
- ✅ 即時使用者列表更新

**測試方式**：多個使用者可以登入並在群聊中互相看到訊息

### 里程碑 3：私訊系統 (第 5 週) ✅ **已完成並強化**
**目標**：實現點對點私訊功能，並進行功能強化與 UI 優化

**已完成功能**：
- [x] 設計私訊協定格式 (`PRIVATE:target_username:message`)
- [x] 實現伺服器端私訊路由邏輯
- [x] 透過在主輸入框使用 `@使用者` 格式，優化了發送體驗
- [x] 實現使用者列表雙擊以快速發起私訊
- [x] 加入未讀訊息標記 (`*`)
- [x] 當私訊目標離線時，向發送方顯示提示

**測試方式**：使用者可以透過 `@使用者` 格式進行私訊，訊息正確傳達，並能看到未讀標記。


## 🏗 系統架構設計

### 核心概念架構
```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Client A      │────▶│     Server      │◀────│   Client B      │
│                 │     │                 │     │                 │
│ - GUI Interface │     │ - User Manager  │     │ - GUI Interface │
│ - TCP Client    │     │ - Message Router│     │ - TCP Client    │
│ - File Handler  │     │ - File Mediator │     │ - File Handler  │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 訊息協定設計
- **群聊廣播**：
  - 客戶端發送: `BROADCAST:message_content`
  - 伺服器廣播: `BROADCAST:timestamp:username:message_content`
- **私人訊息**：
  - 客戶端發送: `PRIVATE:target_username:message_content`
  - 伺服器轉發: `PRIVATE:timestamp:sender_username:target_username:message_content`
- **使用者登入**：`LOGIN:username`
- **使用者登出**：`LOGOUT:username`
- **檔案傳送 (尚未實現)**：
  - `FILE_REQUEST:target_username:filename:filesize`
  - `FILE_RESPONSE:sender_username:accept/reject`

### 系統流程

#### 1. 登入流程
1. 客戶端啟動，顯示登入對話框
2. 使用者輸入使用者名稱，點擊連線
3. 客戶端向伺服器發送 `LOGIN:username`
4. 伺服器驗證使用者名稱是否重複
5. 登入成功後進入聊天室主介面

#### 2. 群聊流程
1. 使用者在訊息輸入框輸入內容
2. 點擊發送按鈕
3. 客戶端發送 `BROADCAST:message_content`
4. 伺服器接收後廣播給所有在線客戶端
5. 所有客戶端更新聊天紀錄顯示

#### 3. 私訊流程
1. 使用者在主聊天視窗的輸入框中，輸入 `@目標使用者名稱` 後跟隨訊息內容。
2. (或) 使用者雙擊在線列表中的目標使用者，系統會自動在輸入框填上 `@目標使用者名稱`。
3. 客戶端發送 `PRIVATE:target_username:message_content`。
4. 伺服器解析目標使用者，若其在線，則轉發訊息。
5. 目標客戶端收到私訊，在聊天視窗顯示內容，並在使用者列表中標記未讀來源。
6. 若目標使用者離線，伺服器會回傳錯誤訊息給發送方。


### 使用者測試
- UI 操作流暢性
- 網路異常恢復
- 大檔案傳輸穩定性

## 🚀 部署與運行

### 開發環境需求
- Visual Studio 2022 或 Cursor IDE
- .NET 8.0 或更高版本
- Windows 10/11 作業系統

### 運行步驟
1. 首先啟動伺服器程式
2. 配置伺服器監聽埠 (預設：8888)
3. 啟動多個客戶端程式進行測試
4. 在瀏覽器控制台查看詳細日誌

### 回退機制
- 使用 Git 版本控制追蹤變更
- 在 Cursor IDE 中使用「回退到檢查點」功能
- 保存重要里程碑的穩定版本


